<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplifly - Daily AI Assistant</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for fonts and layout */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&display=swap');
        
        /* Define color variables for easy theme switching */
        :root {
            --bg-color: #f8f8f5;
            --main-bg-color: #ffffff;
            --card-bg-color: #f9fafb;
            --text-color: #333333;
            --secondary-text-color: #4b5563;
            --border-color: #e5e7eb;
            --date-input-bg: #e0f2fe; /* Light blue, equivalent of sky-100 */
        }

        /* Dark Mode colors */
        .dark-mode {
            --bg-color: #1a1a1a;
            --main-bg-color: #262626;
            --card-bg-color: #1f1f1f;
            --text-color: #e5e5e5;
            --secondary-text-color: #a0a0a0;
            --border-color: #374151;
            --date-input-bg: #2d4154; /* Dark blue, for the date input */
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(180deg, var(--bg-color) 0%, var(--bg-color) 100%);
            color: var(--text-color);
            transition: background-color 0.3s ease;
        }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }
        .difficulty-radio { display: none; }
        .difficulty-radio:checked + .difficulty-label {
            background-color: #4EA8DE;
            color: white;
            border-color: #4EA8DE;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom styles for the tab-like buttons and summary cards */
        .tab-button.active {
            background-color: #4EA8DE;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .urgent-label {
            display: inline-block;
            background-color: #ef4444; /* red-500 */
            color: white;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 9999px; /* full-rounded */
            font-size: 0.75rem;
            line-height: 1;
            vertical-align: middle;
            margin-left: 8px;
        }
        .task-card, .appointment-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
        }
        .task-card:hover, .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .task-card .task-order {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
            color: #4EA8DE;
            margin-right: 1rem;
            width: 2rem;
            text-align: center;
        }
        .subject-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px; /* full-rounded */
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            color: white;
            white-space: nowrap;
        }
        .appointment-date-box {
            background-color: #4EA8DE;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
            flex-shrink: 0;
            width: 5rem;
            margin-right: 1rem;
        }
        .appointment-date-box .month {
            font-size: 0.75rem;
            line-height: 1;
        }
        .appointment-date-box .day {
            font-size: 1.25rem;
            line-height: 1;
        }

        /* Added style for collapsed subtasks */
        .collapsed-subtasks {
            display: none;
        }

        /* Calendar specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            min-height: 100px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .calendar-day:hover {
            background-color: var(--card-bg-color);
        }
        .calendar-day-header {
            font-size: 0.875rem;
            text-align: center;
            font-weight: 600;
            color: var(--secondary-text-color);
        }
        .calendar-day-number {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--text-color);
            position: absolute;
            top: 4px;
            right: 8px;
        }
        .calendar-day.inactive {
            color: var(--secondary-text-color);
            background-color: var(--card-bg-color);
            opacity: 0.5;
            cursor: not-allowed;
        }
        .calendar-day.has-events {
            border-color: #4EA8DE;
            background-color: #e0f2fe; /* sky-100 */
        }
        .dark-mode .calendar-day.has-events {
            background-color: #2d4154; /* Dark blue, for the date input */
        }
        .calendar-events-container {
            margin-top: 24px;
            max-height: 500px;
            overflow-y: auto;
        }
        .calendar-event {
            font-size: 0.75rem;
            line-height: 1;
            padding: 4px 6px;
            border-radius: 4px;
            background-color: #4EA8DE;
            color: white;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }

        /* New styles for delete confirmation */
        .calendar-event.confirm-delete {
            background-color: #ef4444; /* red-500 */
            transition: background-color 0.2s ease;
        }
        .event-details-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 100%; /* Position above the event */
            left: 50%;
            transform: translateX(-50%);
            padding: 8px;
            background-color: #333;
            color: white;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 20;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .calendar-event:hover .event-details-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .selected-date-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #4EA8DE;
            border-radius: 8px;
            box-shadow: 0 0 0 2px #4EA8DE;
            pointer-events: none;
            z-index: 10;
        }
        
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen text-[--text-color]">

    <!-- Main Container -->
    <div class="max-w-5xl w-full bg-[--main-bg-color] shadow-xl rounded-3xl p-6 md:p-10 border border-[--border-color] transition-colors">
        <!-- Header Section -->
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
            <h1 class="text-3xl text-[#4EA8DE]">Simplifly</h1>
            <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                <p class="text-sm text-[--secondary-text-color]">User ID: <span id="user-id" class="font-mono font-bold text-[--text-color]">Loading...</span></p>
                <!-- Dark Mode Toggle Button -->
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-[--card-bg-color] transition-colors">
                    <svg id="moon-icon" class="w-6 h-6 text-[#4EA8DE] hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                    </svg>
                    <svg id="sun-icon" class="w-6 h-6 text-[#4EA8DE]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path>
                    </svg>
                </button>
            </div>
        </div>
        <p class="text-lg text-[--secondary-text-color] font-semibold mb-8 text-center sm:text-left">AI Schedule Organizer</p>

        <!-- Tasks Section -->
        <div class="mb-8 p-6 bg-[--card-bg-color] rounded-2xl border border-[--border-color]">
            <div class="flex items-center justify-between mb-4">
                <h2 id="main-heading" class="text-2xl font-semibold text-[--text-color]">General Tasks</h2>
                <div class="flex rounded-full bg-[--main-bg-color] shadow-md">
                    <button id="toggle-general" class="tab-button active px-4 py-2 rounded-full font-bold text-sm transition-colors duration-200">General Tasks</button>
                    <button id="toggle-school" class="tab-button px-4 py-2 rounded-full font-bold text-sm transition-colors duration-200 text-[--secondary-text-color]">School Assignments</button>
                    <button id="toggle-calendar" class="tab-button px-4 py-2 rounded-full font-bold text-sm transition-colors duration-200 text-[--secondary-text-color]">Calendar</button>
                </div>
            </div>

            <!-- Forms for adding different task types -->
            <!-- General Task Form (Initially visible) -->
            <form id="add-general-task-form" class="grid gap-4 lg:grid-cols-6">
                <input type="text" id="general-assignment-title" placeholder="Task Title" class="lg:col-span-2 p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]">
                <div class="flex flex-col lg:col-span-1 space-y-2">
                    <label for="general-parent-task" class="text-sm font-semibold text-[--text-color]">
                        Parent Task (Optional):
                    </label>
                    <select id="general-parent-task" class="p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]"></select>
                </div>
                <div class="flex flex-col lg:col-span-2 space-y-2">
                    <span class="text-sm font-semibold text-[--text-color]">Difficulty:</span>
                    <div class="flex gap-2">
                        <input type="radio" id="low" name="difficulty-radio" value="low" class="difficulty-radio" checked>
                        <label for="low" class="difficulty-label flex-1 p-3 rounded-xl border border-[--border-color] cursor-pointer transition-all duration-200 ease-in-out bg-[--main-bg-color] text-center">Low</label>
                        <input type="radio" id="medium" name="difficulty-radio" value="medium" class="difficulty-radio">
                        <label for="medium" class="difficulty-label flex-1 p-3 rounded-xl border border-[--border-color] cursor-pointer transition-all duration-200 ease-in-out bg-[--main-bg-color] text-center">Medium</label>
                        <input type="radio" id="high" name="difficulty-radio" value="high" class="difficulty-radio">
                        <label for="high" class="difficulty-label flex-1 p-3 rounded-xl border border-[--border-color] cursor-pointer transition-all duration-200 ease-in-out bg-[--main-bg-color] text-center">High</label>
                    </div>
                </div>
                <div class="flex flex-col lg:col-span-1 space-y-2">
                    <label for="general-assignment-deadline" class="text-sm font-semibold text-[--text-color]">Deadline:</label>
                    <input type="date" id="general-assignment-deadline" class="w-full py-3 px-4 rounded-xl border-2 border-[--border-color] focus:outline-none focus:ring-2 focus:ring-sky-300 transition-colors text-[--text-color]" style="background-color: var(--date-input-bg);">
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="no-deadline-checkbox" class="h-4 w-4 text-[#4EA8DE] border-gray-300 rounded focus:ring-[#4EA8DE]">
                        <label for="no-deadline-checkbox" class="ml-2 text-sm text-[--text-color]">No Deadline</label>
                    </div>
                </div>
                <button type="submit" class="bg-[#4EA8DE] hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors w-full lg:w-auto lg:col-span-1">Add</button>
            </form>

            <!-- School Assignment Form (Initially hidden) -->
            <div id="add-school-task-container" class="hidden">
                <!-- Subject Selector & Add/Remove buttons -->
                <div class="flex flex-col sm:flex-row gap-4 mb-4 items-end">
                    <div class="flex-1">
                        <label for="subject-select" class="text-sm font-semibold text-[--text-color]">Select Subject:</label>
                        <select id="subject-select" class="w-full p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]"></select>
                    </div>
                    <div class="flex-1 flex gap-2">
                        <div class="flex-1">
                            <label for="new-subject-input" class="text-sm font-semibold text-[--text-color]">Or Add New Subject:</label>
                            <input type="text" id="new-subject-input" placeholder="e.g. Physics" class="w-full p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]">
                        </div>
                    </div>
                    <button id="add-subject-btn" class="bg-[#9EE6C8] hover:bg-[#86d4b2] text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors w-full sm:w-auto">Add Subject</button>
                    <button id="remove-subject-btn" title="Remove selected subject" class="bg-gray-300 hover:bg-red-500 hover:text-white text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors w-full sm:w-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                </div>
                
                <form id="add-school-assignment-form" class="grid gap-4 lg:grid-cols-6">
                    <input type="text" id="school-assignment-title" placeholder="Assignment Title" class="lg:col-span-2 p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]">
                    <div class="flex flex-col lg:col-span-1 space-y-2">
                        <label for="school-parent-task" class="text-sm font-semibold text-[--text-color]">
                            Parent Task (Optional):
                        </label>
                        <select id="school-parent-task" class="p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]"></select>
                    </div>
                    <div class="flex flex-col lg:col-span-2 space-y-2">
                        <span class="text-sm font-semibold text-[--text-color]">Difficulty:</span>
                        <div class="flex gap-2">
                            <input type="radio" id="school-low" name="school-difficulty-radio" value="low" class="difficulty-radio" checked>
                            <label for="school-low" class="difficulty-label flex-1 p-3 rounded-xl border border-[--border-color] cursor-pointer transition-all duration-200 ease-in-out bg-[--main-bg-color] text-center">Low</label>
                            <input type="radio" id="school-medium" name="school-difficulty-radio" value="medium" class="difficulty-radio">
                            <label for="school-medium" class="difficulty-label flex-1 p-3 rounded-xl border border-[--border-color] cursor-pointer transition-all duration-200 ease-in-out bg-[--main-bg-color] text-center">Medium</label>
                            <input type="radio" id="school-high" name="school-difficulty-radio" value="high" class="difficulty-radio">
                            <label for="school-high" class="difficulty-label flex-1 p-3 rounded-xl border border-[--border-color] cursor-pointer transition-all duration-200 ease-in-out bg-[--main-bg-color] text-center">High</label>
                        </div>
                    </div>
                    <div class="flex flex-col lg:col-span-1 space-y-2">
                        <label for="school-assignment-deadline" class="text-sm font-semibold text-[--text-color]">Deadline:</label>
                        <input type="date" id="school-assignment-deadline" class="w-full py-3 px-4 rounded-xl border-2 border-[--border-color] focus:outline-none focus:ring-2 focus:ring-sky-300 transition-colors text-[--text-color]" style="background-color: var(--date-input-bg);">
                    </div>
                    <button type="submit" class="bg-[#4EA8DE] hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors w-full lg:w-auto lg:col-span-1">Add</button>
                </form>
            </div>

            <!-- Calendar View Container -->
            <div id="calendar-view-container" class="hidden">
                <!-- Add Calendar Event Form -->
                <form id="add-calendar-event-form" class="grid gap-4 md:grid-cols-2 lg:grid-cols-5 mb-8">
                    <input type="text" id="event-title-input" placeholder="Event Title" required class="md:col-span-2 p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]">
                    <div class="flex flex-col space-y-2">
                        <label for="event-date-input" class="text-sm font-semibold text-[--text-color]">Event Date:</label>
                        <input type="date" id="event-date-input" required class="w-full py-3 px-4 rounded-xl border-2 border-[--border-color] focus:outline-none focus:ring-2 focus:ring-sky-300 transition-colors text-[--text-color]" style="background-color: var(--date-input-bg);">
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label for="event-time-input" class="text-sm font-semibold text-[--text-color]">Time (Optional):</label>
                        <input type="time" id="event-time-input" class="w-full py-3 px-4 rounded-xl border-2 border-[--border-color] focus:outline-none focus:ring-2 focus:ring-sky-300 transition-colors text-[--text-color]" style="background-color: var(--date-input-bg);">
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label for="event-location-input" class="text-sm font-semibold text-[--text-color]">Location (Optional):</label>
                        <input type="text" id="event-location-input" placeholder="e.g. Room 101" class="w-full p-3 rounded-xl border border-[--border-color] focus:outline-none focus:ring-2 focus:ring-[#4EA8DE] bg-[--main-bg-color] text-[--text-color]">
                    </div>
                    <div class="flex items-center space-x-2 lg:col-span-2 mt-2">
                        <input type="checkbox" id="recurring-checkbox" class="h-4 w-4 text-[#4EA8DE] border-gray-300 rounded focus:ring-[#4EA8DE]">
                        <label for="recurring-checkbox" class="ml-2 text-sm text-[--text-color]">Recurring Event (Weekly)</label>
                    </div>
                    <button type="submit" class="bg-[#4EA8DE] hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors w-full lg:w-auto md:col-span-2 lg:col-span-1">Add Event</button>
                </form>

                <!-- Calendar Display -->
                <div class="calendar-container p-6 bg-[--main-bg-color] rounded-2xl border border-[--border-color] shadow-inner">
                    <!-- Calendar Header with month and navigation -->
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-[--card-bg-color] transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left text-[#4EA8DE]"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <h3 id="current-month-year" class="text-xl font-bold text-[--text-color] text-center">Month Year</h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-[--card-bg-color] transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right text-[#4EA8DE]"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                    <!-- Day of the week headers -->
                    <div class="calendar-grid mb-2">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <!-- Calendar days grid -->
                    <div id="calendar-grid-body" class="calendar-grid">
                        <!-- Calendar days will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <div id="assignments-list" class="space-y-3 text-sm text-[--text-color] mt-4">
                <p id="assignments-placeholder" class="text-[--secondary-text-color] text-center italic mt-4">Add a task to get started.</p>
            </div>
        </div>

        <!-- Action Buttons Section -->
        <div class="mb-8 p-6 bg-[--card-bg-color] rounded-2xl border border-[--border-color] flex flex-col md:flex-row gap-4 justify-between items-center">
            <button id="connect-calendar-btn" class="bg-[#9EE6C8] hover:bg-[#86d4b2] text-white font-bold py-2 px-6 rounded-full shadow-lg transition-colors w-full md:w-auto" disabled>
                Connect Google Calendar (Coming Soon)
            </button>
            <button id="generate-btn" class="bg-[#4EA8DE] hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-colors w-full md:w-auto">
                Generate Summary
            </button>
        </div>

        <!-- Loading and Summary Output Section -->
        <div id="loading" class="hidden flex justify-center items-center h-48">
            <div class="w-9 h-9 rounded-full border-4 border-[--border-color] border-l-[#4EA8DE] animate-spin"></div>
        </div>
        <div id="summary-output" class="hidden p-6 rounded-xl shadow-md transition-opacity">
        </div>
    </div>
    <div id="message-box" class="fixed bottom-4 right-4 py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform translate-y-full opacity-0 z-50 text-white"></div>
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-[--main-bg-color] p-6 rounded-xl shadow-lg border border-[--border-color] max-w-sm w-full">
            <p id="modal-text" class="text-[--text-color] text-center mb-4">Are you sure you want to delete this event?</p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition-colors">Yes, Delete</button>
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Google API library for Calendar integration -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script type="module">
        // Import Firebase SDK modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, updateDoc, doc, serverTimestamp, deleteDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- IMPORTANT: CONFIGURE YOUR FIREBASE AND GOOGLE API KEYS HERE ---
        // 1. Go to https://firebase.google.com/ and create a new project.
        // 2. Add a web app to your project and copy the configuration object.
        // 3. Paste the config object below.
        const firebaseConfig = {
            apiKey: "AIzaSyDzMgpUM9wgrSBWgk50AvmnBFE_f7IvJ_Q",
            authDomain: "simplifly-efd5f.firebaseapp.com",
            projectId: "simplifly-efd5f",
            storageBucket: "simplifly-efd5f.firebasestorage.app",
            messagingSenderId: "478943856947",
            appId: "1:478943856947:web:07b95a8c0be06dd73c5646",
            measurementId: "G-6MR8C52BQX"
        };
        // 4. Go to Google Cloud Console, enable the Gemini API, and create an API key.
        // 5. Paste the Gemini API key below.
        const GEMINI_API_KEY = "AIzaSyDdXPBr8zj5r_vtMEJRihR4tDQexDzRK44";

        // --- DO NOT EDIT BELOW THIS LINE ---
        const appId = firebaseConfig.projectId || 'default-app-id';
        
        // Google Calendar API Constants (left for future development)
        const GOOGLE_API_CLIENT_ID = '478943856947-e1t3709d3aj6ce1r6dele2dho0qhhi54.apps.googleusercontent.com';
        const GOOGLE_API_DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const GOOGLE_API_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
        
        // State Variables
        let app, db, auth;
        let userId;
        let assignments = [];
        let events = []; // New array to hold calendar events
        let isAuthReady = false;
        let googleCalendarEvents = [];
        let taskMode = 'general'; // new state variable for task type
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let subjectColors = {}; // New map to store subject colors

        // State for expanded/collapsed parent tasks
        const expandedParentTasks = new Set();
        
        // Constants for urgent logic and styling
        const VERY_SOON_DAYS = 3;
        const SEMI_SOON_DAYS = 7;
        const COLOR_PALETTE = ['#FCA5A5', '#FDBA74', '#FCD34D', '#A7F3D0', '#A5F3FC', '#A5B4FC', '#C4B5FD', '#FBCFE8', '#FDE68A'];
        
        // --- DOM Elements ---
        const userIdSpan = document.getElementById('user-id');
        const generalTaskForm = document.getElementById('add-general-task-form');
        const schoolAssignmentForm = document.getElementById('add-school-assignment-form');
        const generalAssignmentTitleInput = document.getElementById('general-assignment-title');
        const generalAssignmentDeadlineInput = document.getElementById('general-assignment-deadline');
        const noDeadlineCheckbox = document.getElementById('no-deadline-checkbox');
        const schoolAssignmentTitleInput = document.getElementById('school-assignment-title');
        const schoolAssignmentDeadlineInput = document.getElementById('school-assignment-deadline');
        const assignmentsListDiv = document.getElementById('assignments-list');
        const connectCalendarBtn = document.getElementById('connect-calendar-btn');
        const generateBtn = document.getElementById('generate-btn');
        const loadingDiv = document.getElementById('loading');
        const summaryOutputDiv = document.getElementById('summary-output');
        const messageBox = document.getElementById('message-box');
        const toggleGeneralBtn = document.getElementById('toggle-general');
        const toggleSchoolBtn = document.getElementById('toggle-school');
        const toggleCalendarBtn = document.getElementById('toggle-calendar');
        const schoolTaskContainer = document.getElementById('add-school-task-container');
        const calendarViewContainer = document.getElementById('calendar-view-container');
        const addCalendarEventForm = document.getElementById('add-calendar-event-form');
        const eventTitleInput = document.getElementById('event-title-input');
        const eventDateInput = document.getElementById('event-date-input');
        const eventTimeInput = document.getElementById('event-time-input');
        const eventLocationInput = document.getElementById('event-location-input');
        const recurringCheckbox = document.getElementById('recurring-checkbox');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthYearHeader = document.getElementById('current-month-year');
        const calendarGridBody = document.getElementById('calendar-grid-body');
        const mainHeading = document.getElementById('main-heading');
        const subjectSelect = document.getElementById('subject-select');
        const newSubjectInput = document.getElementById('new-subject-input');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const removeSubjectBtn = document.getElementById('remove-subject-btn');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const generalParentTaskSelect = document.getElementById('general-parent-task');
        const schoolParentTaskSelect = document.getElementById('school-parent-task');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');


        // --- Initialization and Event Handlers ---

        /**
         * Initializes Firebase authentication and listeners.
         */
        async function initializeAppAndAuth() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith('YOUR_')) {
                    showMessage("Please update your Firebase credentials in the script.", "bg-red-500", 8000);
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Listen for authentication state changes to set up app state
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        isAuthReady = true;
                        // Fetch initial data once auth is ready
                        listenForAssignments();
                        listenForEvents();
                        fetchSubjects();
                        generateBtn.disabled = false;
                    } else {
                        console.log("No user signed in. Attempting anonymous authentication.");
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            userIdSpan.textContent = 'Auth Failed';
                            isAuthReady = true;
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                userIdSpan.textContent = 'Init Failed';
                showMessage("Firebase initialization failed. Check the console.", "bg-red-500", 5000);
            }
        }
        
        window.onload = initializeAppAndAuth;

        // Apply theme on page load based on localStorage
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            updateThemeIcons(true);
        } else {
            updateThemeIcons(false);
        }

        // --- UI & State Management ---

        /**
         * Toggles the theme between light and dark mode.
         */
        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeIcons(isDarkMode);
        });

        /**
         * Updates the visibility of the sun and moon icons based on the theme.
         * @param {boolean} isDarkMode - True if dark mode is active.
         */
        function updateThemeIcons(isDarkMode) {
            if (isDarkMode) {
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            } else {
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            }
        }

        /**
         * Switches the main view between general tasks, school assignments, and calendar.
         * @param {string} mode - The mode to switch to ('general', 'school', or 'calendar').
         */
        function setTaskMode(mode) {
            [toggleGeneralBtn, toggleSchoolBtn, toggleCalendarBtn].forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-[--secondary-text-color]');
            });
            [generalTaskForm, schoolTaskContainer, calendarViewContainer, assignmentsListDiv].forEach(container => {
                container.classList.add('hidden');
            });
            
            taskMode = mode;
            if (mode === 'general') {
                mainHeading.textContent = 'General Tasks';
                toggleGeneralBtn.classList.add('active');
                toggleGeneralBtn.classList.remove('text-[--secondary-text-color]');
                generalTaskForm.classList.remove('hidden');
                assignmentsListDiv.classList.remove('hidden');
            } else if (mode === 'school') {
                mainHeading.textContent = 'School Assignments';
                toggleSchoolBtn.classList.add('active');
                toggleSchoolBtn.classList.remove('text-[--secondary-text-color]');
                schoolTaskContainer.classList.remove('hidden');
                assignmentsListDiv.classList.remove('hidden');
            } else if (mode === 'calendar') {
                mainHeading.textContent = 'Calendar';
                toggleCalendarBtn.classList.add('active');
                toggleCalendarBtn.classList.remove('text-[--secondary-text-color]');
                calendarViewContainer.classList.remove('hidden');
                renderCalendar();
            }
        }

        // Add event listeners for the toggle buttons
        toggleGeneralBtn.addEventListener('click', () => setTaskMode('general'));
        toggleSchoolBtn.addEventListener('click', () => setTaskMode('school'));
        toggleCalendarBtn.addEventListener('click', () => setTaskMode('calendar'));

        // Toggle deadline input based on checkbox
        noDeadlineCheckbox.addEventListener('change', (e) => {
            generalAssignmentDeadlineInput.disabled = e.target.checked;
            generalAssignmentDeadlineInput.value = '';
            generalAssignmentDeadlineInput.placeholder = e.target.checked ? 'No deadline' : '';
        });

        // --- Helper Functions ---

        /**
         * Displays a temporary message box.
         * @param {string} text - The message to display.
         * @param {string} bgColor - The Tailwind CSS background color class.
         * @param {number} duration - The duration in milliseconds to display the message.
         */
        function showMessage(text, bgColor, duration) {
            messageBox.textContent = text;
            messageBox.className = `fixed bottom-4 right-4 py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform translate-y-0 opacity-100 z-50 ${bgColor} text-white`;
            setTimeout(() => {
                messageBox.className = `fixed bottom-4 right-4 py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform translate-y-full opacity-0 z-50 ${bgColor} text-white`;
            }, duration);
        }

        /**
         * Sorts assignments by deadline and then by difficulty.
         * @param {Array<Object>} assignments - An array of assignment objects.
         * @returns {Array<Object>} The sorted array.
         */
        function sortAssignments(assignments) {
            const difficultyMap = { 'high': 3, 'medium': 2, 'low': 1 };
            return assignments.sort((a, b) => {
                if (!a.deadline && b.deadline) return 1;
                if (a.deadline && !b.deadline) return -1;
                if (!a.deadline && !b.deadline) return 0;
                
                const deadlineA = new Date(a.deadline + 'T12:00:00');
                const deadlineB = new Date(b.deadline + 'T12:00:00');
                if (deadlineA.getTime() !== deadlineB.getTime()) {
                    return deadlineA.getTime() - deadlineB.getTime();
                }
                return difficultyMap[b.difficulty] - difficultyMap[a.difficulty];
            });
        }
        
        /**
         * Populates the parent task dropdowns with a list of non-completed tasks.
         * @param {Array<Object>} tasks - A list of task objects.
         */
        function populateParentTaskSelect(tasks) {
            const generalTasks = tasks.filter(t => t.taskType === 'general' && !t.parentTaskId);
            const schoolAssignments = tasks.filter(t => t.taskType === 'school' && !t.parentTaskId);

            function createOptions(selectElement, taskList) {
                selectElement.innerHTML = '<option value="">(None)</option>';
                taskList.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = task.title;
                    selectElement.appendChild(option);
                });
            }

            createOptions(generalParentTaskSelect, generalTasks);
            createOptions(schoolParentTaskSelect, schoolAssignments);
        }

        /**
         * Gets a consistent color for a subject based on its name.
         * @param {string} subject - The subject name.
         * @returns {string} A hex color code.
         */
        function getSubjectColor(subject) {
            const lowerSubject = subject.toLowerCase();
            if (['history', 'business', 'economics'].some(s => lowerSubject.includes(s))) {
                return '#A7F3D0'; // Green
            } else if (['english', 'literature', 'writing'].some(s => lowerSubject.includes(s))) {
                return '#FCD34D'; // Yellow
            } else if (['science', 'biology', 'chemistry', 'physics'].some(s => lowerSubject.includes(s))) {
                return '#C4B5FD'; // Purple
            } else if (['math', 'mathematics', 'calculus', 'algebra'].some(s => lowerSubject.includes(s))) {
                return '#A5B4FC'; // Blue
            }
            return COLOR_PALETTE[Object.keys(subjectColors).length % COLOR_PALETTE.length];
        }

        // --- Firebase Integration ---
        
        /**
         * Listens for real-time updates to the assignments collection.
         */
        function listenForAssignments() {
            if (!isAuthReady || !db) return;
            const privateAssignmentsCollection = collection(db, `artifacts/${appId}/users/${userId}/assignments`);
            onSnapshot(privateAssignmentsCollection, (querySnapshot) => {
                const now = new Date();
                const overdueTasks = [];
                assignments = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.deadline && new Date(data.deadline + 'T12:00:00') < now && !data.completed) {
                        overdueTasks.push(doc.id);
                    }
                    assignments.push({ ...data, id: doc.id });
                });
                overdueTasks.forEach(id => removeAssignment(id, false));
                populateParentTaskSelect(assignments.filter(t => !t.completed));
                renderAssignments(assignments);
            }, (error) => {
                console.error("Error setting up Firestore listener for assignments:", error);
            });
        }

        /**
         * Listens for real-time updates to the events collection.
         */
        function listenForEvents() {
            if (!isAuthReady || !db) return;
            const eventsCollection = collection(db, `artifacts/${appId}/users/${userId}/events`);
            onSnapshot(eventsCollection, (querySnapshot) => {
                events = querySnapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                renderCalendar();
            }, (error) => {
                console.error("Error setting up Firestore listener for events:", error);
            });
        }
        
        /**
         * Fetches all subjects and populates the subject dropdown.
         */
        async function fetchSubjects() {
            if (!isAuthReady || !db) return;
            const subjectsCollection = collection(db, `artifacts/${appId}/users/${userId}/subjects`);
            try {
                const querySnapshot = await getDocs(subjectsCollection);
                subjectSelect.innerHTML = '';
                subjectColors = {};
                let hasSubjects = false;
                querySnapshot.forEach((doc) => {
                    const subjectData = doc.data();
                    const subject = subjectData.name;
                    const color = subjectData.color || getSubjectColor(subject);
                    subjectColors[subject] = color;
                    
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                    hasSubjects = true;
                });
                if (!hasSubjects) {
                    subjectSelect.innerHTML = '<option value="" disabled selected>No subjects added yet</option>';
                }
            } catch (e) {
                console.error("Error fetching subjects: ", e);
                showMessage("Error fetching subjects.", "bg-red-500", 5000);
            }
        }
        
        /**
         * Toggles the completion status of a task.
         * @param {string} docId - The ID of the task document.
         */
        async function toggleCompletion(docId) {
            if (!db) { showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }
            try {
                const task = assignments.find(t => t.id === docId);
                if (!task) { showMessage("Task not found.", "bg-red-500", 5000); return; }
                
                if (!task.completed) {
                    const subtasks = assignments.filter(t => t.parentTaskId === docId && !t.completed);
                    if (subtasks.length > 0) {
                        showMessage("Please complete all subtasks first.", "bg-red-500", 5000);
                        return;
                    }
                }
                
                const assignmentRef = doc(db, `artifacts/${appId}/users/${userId}/assignments`, docId);
                await updateDoc(assignmentRef, { completed: !task.completed });
                showMessage(`Task marked as ${!task.completed ? 'done' : 'incomplete'}!`, "bg-[#9EE6C8]", 3000);
            } catch (e) {
                console.error("Error updating document:", e);
                showMessage("Error marking task as done.", "bg-red-500", 5000);
            }
        }
        
        /**
         * Removes a task from the database.
         * @param {string} docId - The ID of the task document.
         * @param {boolean} [showMsg=true] - Whether to show a success message.
         */
        async function removeAssignment(docId, showMsg = true) {
            if (!db) { if (showMsg) showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }
            try {
                const assignmentRef = doc(db, `artifacts/${appId}/users/${userId}/assignments`, docId);
                await deleteDoc(assignmentRef);
                if (showMsg) showMessage("Task removed!", "bg-[#333333]", 3000);
            } catch (e) {
                console.error("Error removing document:", e);
                if (showMsg) showMessage("Error removing task.", "bg-red-500", 5000);
            }
        }

        /**
         * Removes an event from the database.
         * @param {string} docId - The ID of the event document.
         */
        async function removeEvent(docId) {
            if (!db) { showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }
            try {
                const eventRef = doc(db, `artifacts/${appId}/users/${userId}/events`, docId);
                await deleteDoc(eventRef);
                showMessage("Event removed!", "bg-[#333333]", 3000);
            } catch (e) {
                console.error("Error removing event:", e);
                showMessage("Error removing event.", "bg-red-500", 5000);
            }
        }
        
        // --- Form Submission Handlers ---
        
        generalTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = generalAssignmentTitleInput.value;
            const deadline = generalAssignmentDeadlineInput.value;
            const difficulty = document.querySelector('input[name="difficulty-radio"]:checked').value;
            const parentTaskId = generalParentTaskSelect.value || null;
            
            if (!title) { showMessage("Please enter a task title.", "bg-red-500", 5000); return; }
            if (!deadline && !noDeadlineCheckbox.checked) { showMessage("Please enter a deadline or select 'No Deadline'.", "bg-red-500", 5000); return; }
            
            if (parentTaskId && deadline) {
                const parentTask = assignments.find(t => t.id === parentTaskId);
                if (parentTask && parentTask.deadline && new Date(deadline) > new Date(parentTask.deadline)) {
                    showMessage("Subtask deadline cannot be after the parent task's deadline.", "bg-red-500", 5000);
                    return;
                }
            }

            if (!db) { showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }
            try {
                const privateAssignmentsCollection = collection(db, `artifacts/${appId}/users/${userId}/assignments`);
                await addDoc(privateAssignmentsCollection, {
                    title: title,
                    deadline: deadline || null,
                    difficulty: difficulty,
                    taskType: 'general',
                    parentTaskId: parentTaskId,
                    completed: false,
                    createdAt: serverTimestamp()
                });
                generalTaskForm.reset();
                generalAssignmentDeadlineInput.disabled = false;
                showMessage("General task added successfully!", "bg-[#9EE6C8]", 3000);
            } catch (e) {
                console.error("Error adding document:", e);
                showMessage("Error adding task. Check the console for details.", "bg-red-500", 5000);
            }
        });

        schoolAssignmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = schoolAssignmentTitleInput.value;
            const deadline = schoolAssignmentDeadlineInput.value;
            const difficulty = document.querySelector('input[name="school-difficulty-radio"]:checked').value;
            const subject = subjectSelect.value;
            const parentTaskId = schoolParentTaskSelect.value || null;

            if (!title || !deadline || !difficulty || !subject) {
                showMessage("Please fill out all fields to add an assignment.", "bg-red-500", 5000);
                return;
            }

            if (parentTaskId && deadline) {
                const parentTask = assignments.find(t => t.id === parentTaskId);
                if (parentTask && parentTask.deadline && new Date(deadline) > new Date(parentTask.deadline)) {
                    showMessage("Subtask deadline cannot be after the parent task's deadline.", "bg-red-500", 5000);
                    return;
                }
            }
            
            if (!db) { showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }
            try {
                const privateAssignmentsCollection = collection(db, `artifacts/${appId}/users/${userId}/assignments`);
                await addDoc(privateAssignmentsCollection, {
                    title: title,
                    deadline: deadline,
                    difficulty: difficulty,
                    subject: subject,
                    taskType: 'school',
                    parentTaskId: parentTaskId,
                    completed: false,
                    createdAt: serverTimestamp()
                });
                schoolAssignmentForm.reset();
                showMessage("School assignment added successfully!", "bg-[#9EE6C8]", 3000);
            } catch (e) {
                console.error("Error adding document:", e);
                showMessage("Error adding assignment. Check the console for details.", "bg-red-500", 5000);
            }
        });
        
        addCalendarEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = eventTitleInput.value;
            const date = eventDateInput.value;
            const time = eventTimeInput.value || null;
            const location = eventLocationInput.value || null;
            const isRecurring = recurringCheckbox.checked;
            
            if (!title || !date) { showMessage("Please enter both an event title and date.", "bg-red-500", 5000); return; }
            if (!db) { showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }
            
            try {
                const eventsCollection = collection(db, `artifacts/${appId}/users/${userId}/events`);
                if (isRecurring) {
                    const initialDate = new Date(date);
                    const weekInMillis = 7 * 24 * 60 * 60 * 1000;
                    for (let i = 0; i < 52; i++) {
                        const newDate = new Date(initialDate.getTime() + (i * weekInMillis));
                        const newDateString = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}-${String(newDate.getDate()).padStart(2, '0')}`;
                        await addDoc(eventsCollection, {
                            title, date: newDateString, time, location, isRecurring: true, createdAt: serverTimestamp()
                        });
                    }
                    showMessage("Recurring events added successfully!", "bg-[#9EE6C8]", 3000);
                } else {
                    await addDoc(eventsCollection, {
                        title, date, time, location, isRecurring: false, createdAt: serverTimestamp()
                    });
                    showMessage("Event added successfully!", "bg-[#9EE6C8]", 3000);
                }
                
                addCalendarEventForm.reset();
            } catch (e) {
                console.error("Error adding event:", e);
                showMessage("Error adding event. Check the console for details.", "bg-red-500", 5000);
            }
        });

        // --- Subject Management ---
        
        addSubjectBtn.addEventListener('click', async () => {
            const newSubject = newSubjectInput.value.trim();
            if (!newSubject) { showMessage("Please enter a subject name.", "bg-red-500", 5000); return; }
            if (!db) { showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }
            try {
                const subjectsCollection = collection(db, `artifacts/${appId}/users/${userId}/subjects`);
                const color = getSubjectColor(newSubject);
                await addDoc(subjectsCollection, { name: newSubject, color: color });
                newSubjectInput.value = '';
                fetchSubjects();
                showMessage("Subject added successfully!", "bg-[#9EE6C8]", 3000);
            } catch (e) {
                console.error("Error adding subject: ", e);
                showMessage("Error adding subject.", "bg-red-500", 5000);
            }
        });

        removeSubjectBtn.addEventListener('click', async () => {
            const subjectToRemove = subjectSelect.value;
            if (!subjectToRemove || subjectToRemove === 'No subjects added yet') { showMessage("Please select a valid subject to remove.", "bg-red-500", 3000); return; }
            if (!db) { showMessage("Database functions are disabled.", "bg-gray-500", 5000); return; }

            try {
                const assignmentsRef = collection(db, `artifacts/${appId}/users/${userId}/assignments`);
                const q = query(assignmentsRef, where('subject', '==', subjectToRemove));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showMessage("Cannot remove subject: it still has assignments. Please remove or update the assignments first.", "bg-red-500", 5000);
                    return;
                }

                const subjectsRef = collection(db, `artifacts/${appId}/users/${userId}/subjects`);
                const subjectQuery = query(subjectsRef, where('name', '==', subjectToRemove));
                const subjectSnapshot = await getDocs(subjectQuery);
                
                if (!subjectSnapshot.empty) {
                    const docId = subjectSnapshot.docs[0].id;
                    const subjectDocRef = doc(subjectsRef, docId);
                    await deleteDoc(subjectDocRef);
                    fetchSubjects();
                    showMessage(`Subject '${subjectToRemove}' removed successfully!`, "bg-[#333333]", 3000);
                }
            } catch (e) {
                console.error("Error removing subject:", e);
                showMessage("Error removing subject.", "bg-red-500", 5000);
            }
        });

        // --- Assignment Rendering ---

        function renderAssignments(assignmentsToRender) {
            assignmentsListDiv.innerHTML = '';
            if (assignmentsToRender.length === 0) {
                assignmentsListDiv.innerHTML = '<p id="assignments-placeholder" class="text-[--secondary-text-color] text-center italic mt-4">Add a task to get started.</p>';
                return;
            }
            
            const activeAssignments = assignmentsToRender.filter(t => !t.completed);
            const completedAssignments = assignmentsToRender.filter(t => t.completed);

            const sortedActiveAssignments = sortAssignments(activeAssignments);
            const activeTopLevelTasks = sortedActiveAssignments.filter(task => !task.parentTaskId);
            
            const groupedActiveAssignments = {};
            activeTopLevelTasks.forEach(task => {
                const key = task.taskType === 'school' ? task.subject : 'General Tasks';
                if (!groupedActiveAssignments[key]) {
                    groupedActiveAssignments[key] = [];
                }
                groupedActiveAssignments[key].push(task);
            });

            for (const key in groupedActiveAssignments) {
                const groupTitle = document.createElement('h3');
                groupTitle.className = 'text-lg font-semibold text-[--text-color] mt-4 mb-2';
                groupTitle.textContent = key;
                assignmentsListDiv.appendChild(groupTitle);
                
                groupedActiveAssignments[key].forEach((taskData) => {
                    const taskElement = createAssignmentElement(taskData, assignmentsToRender);
                    assignmentsListDiv.appendChild(taskElement);
                    if (expandedParentTasks.has(taskData.id)) {
                        const subtasks = sortedActiveAssignments.filter(sub => sub.parentTaskId === taskData.id);
                        subtasks.forEach(subtaskData => {
                            const subtaskElement = createAssignmentElement(subtaskData, assignmentsToRender, true);
                            assignmentsListDiv.appendChild(subtaskElement);
                        });
                    }
                });
            }
            
            if (completedAssignments.length > 0) {
                const completedTitle = document.createElement('h3');
                completedTitle.className = 'text-lg font-semibold text-[--secondary-text-color] mt-6 mb-2';
                completedTitle.textContent = 'Completed Tasks';
                assignmentsListDiv.appendChild(completedTitle);
                
                const sortedCompletedAssignments = sortAssignments(completedAssignments);
                sortedCompletedAssignments.forEach(taskData => {
                    const taskElement = createAssignmentElement(taskData, assignmentsToRender);
                    assignmentsListDiv.appendChild(taskElement);
                });
            }
        }

        function createAssignmentElement(data, allAssignments, isSubtask = false) {
            const assignmentEl = document.createElement('div');
            
            const isParent = allAssignments.some(t => t.parentTaskId === data.id);
            const isExpanded = expandedParentTasks.has(data.id);
            
            const baseClass = 'flex justify-between items-center p-3 rounded-xl border shadow-sm transition-shadow hover:shadow-md border-[--border-color]';
            const bgColor = data.completed ? 'bg-[#c5ffdc] dark:bg-[#2e5e49] opacity-90' : 'bg-[--main-bg-color]';
            const mlClass = isSubtask ? 'ml-6' : '';
            assignmentEl.className = `${baseClass} ${bgColor} ${mlClass}`;
            
            let isUrgent = false;
            let deadlineString = 'No Deadline';
            if (data.deadline) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const deadline = new Date(data.deadline + 'T12:00:00');
                deadlineString = deadline.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const timeDifference = deadline.getTime() - today.getTime();
                const daysDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
                
                if (daysDifference <= VERY_SOON_DAYS || (data.difficulty === 'high' && daysDifference <= SEMI_SOON_DAYS)) {
                    isUrgent = true;
                }
            }

            const leftContent = document.createElement('div');
            leftContent.className = 'flex items-center space-x-2';
            
            if (isParent && !data.completed) {
                const collapseBtn = document.createElement('button');
                collapseBtn.className = `p-1 rounded-full text-[--secondary-text-color] hover:bg-[--card-bg-color] transition-colors`;
                collapseBtn.innerHTML = isExpanded
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>`;
                collapseBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (isExpanded) {
                        expandedParentTasks.delete(data.id);
                    } else {
                        expandedParentTasks.add(data.id);
                    }
                    renderAssignments(allAssignments);
                };
                leftContent.appendChild(collapseBtn);
            }
            
            const titleSpan = document.createElement('span');
            const isDarkMode = document.body.classList.contains('dark-mode');
            const completedTextColorClass = isDarkMode ? 'text-gray-400' : 'text-gray-600';
            titleSpan.className = `font-bold ${data.completed ? `line-through ${completedTextColorClass}` : ''}`;
            titleSpan.textContent = data.title;
            leftContent.appendChild(titleSpan);

            if (isUrgent && !data.completed) {
                const urgentLabel = document.createElement('span');
                urgentLabel.className = 'urgent-label';
                urgentLabel.textContent = 'URGENT';
                leftContent.appendChild(urgentLabel);
            }

            if (data.taskType === 'school' && data.subject) {
                const subjectLabel = document.createElement('span');
                subjectLabel.className = 'subject-label';
                subjectLabel.textContent = data.subject;
                subjectLabel.style.backgroundColor = subjectColors[data.subject] || '#4EA8DE';
                leftContent.appendChild(subjectLabel);
            }

            const rightContent = document.createElement('div');
            rightContent.className = 'flex gap-4 items-center flex-shrink-0';
            
            const infoSpan = document.createElement('span');
            infoSpan.className = `ml-2 text-xs text-[--secondary-text-color] font-medium whitespace-nowrap`;
            infoSpan.innerHTML = `(<span class="font-semibold">Due:</span> ${deadlineString}, <span class="font-semibold">Difficulty:</span> ${data.difficulty.charAt(0).toUpperCase() + data.difficulty.slice(1)})`;
            rightContent.appendChild(infoSpan);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex gap-2 items-center';
            
            const doneBtn = document.createElement('button');
            doneBtn.innerHTML = data.completed
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2 text-[#4EA8DE]"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.6"/><path d="m9 12 2 2 4-4"/></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle text-[#4EA8DE]"><circle cx="12" cy="12" r="10"/></svg>`;
            doneBtn.title = data.completed ? "Mark as incomplete" : "Mark as done";
            doneBtn.className = 'bg-[--card-bg-color] hover:bg-[--border-color] text-[--text-color] font-medium py-1 px-1.5 rounded-lg text-xs transition-colors border border-[--border-color]';
            doneBtn.onclick = (event) => {
                event.stopPropagation();
                toggleCompletion(data.id);
            };
            buttonContainer.appendChild(doneBtn);
            
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-[#4EA8DE]"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
            removeBtn.title = "Remove task";
            removeBtn.className = 'bg-[--card-bg-color] hover:bg-red-500 hover:text-white text-gray-500 font-medium p-1.5 rounded-lg text-xs transition-colors border border-[--border-color]';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                showDeleteConfirmation(data.id, 'task');
            };
            
            buttonContainer.appendChild(removeBtn);
            
            rightContent.appendChild(buttonContainer);
            
            assignmentEl.appendChild(leftContent);
            assignmentEl.appendChild(rightContent);

            return assignmentEl;
        }

        // --- Calendar Logic ---
        
        /**
         * Renders the calendar grid for the current month and year.
         */
        function renderCalendar() {
            const date = new Date(currentYear, currentMonth);
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            currentMonthYearHeader.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            calendarGridBody.innerHTML = '';
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'calendar-day inactive';
                calendarGridBody.appendChild(emptyDiv);
            }

            for (let day = 1; day <= lastDay; day++) {
                const dayDiv = document.createElement('div');
                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                dayDiv.className = 'calendar-day relative';
                dayDiv.dataset.date = dateString;

                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.className = 'calendar-day-number';
                dayNumberSpan.textContent = day;
                dayDiv.appendChild(dayNumberSpan);

                const eventsForDay = events.filter(e => e.date === dateString).sort((a, b) => {
                    if (a.time && b.time) return a.time.localeCompare(b.time);
                    if (a.time) return -1;
                    if (b.time) return 1;
                    return 0;
                });

                if (eventsForDay.length > 0) {
                    dayDiv.classList.add('has-events');
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'calendar-events-container';
                    eventsForDay.forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'calendar-event flex items-center gap-2 relative';
                        eventDiv.dataset.eventId = event.id;
                        
                        eventDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check"><path d="M21 14V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M7 4v2"/><path d="M17 4v2"/><path d="M3 10h18"/><path d="m16 20 2-2 4 4"/></svg>
                        <span class="truncate">${event.title}</span>`;

                        const tooltip = document.createElement('div');
                        tooltip.className = 'event-details-tooltip';
                        let details = event.title;
                        if (event.time) { details += ` at ${formatTime(event.time)}`; }
                        if (event.location) { details += ` in ${event.location}`; }
                        tooltip.textContent = details;
                        eventDiv.appendChild(tooltip);
                        
                        eventDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showDeleteConfirmation(event.id, 'event');
                        });
                        eventsContainer.appendChild(eventDiv);
                    });
                    dayDiv.appendChild(eventsContainer);
                }

                dayDiv.addEventListener('click', () => {
                    const existingIndicator = document.querySelector('.selected-date-indicator');
                    if (existingIndicator) existingIndicator.remove();

                    if (selectedDate !== dateString) {
                        const indicator = document.createElement('div');
                        indicator.className = 'selected-date-indicator';
                        dayDiv.appendChild(indicator);
                        selectedDate = dateString;
                        eventDateInput.value = dateString;
                    } else {
                        selectedDate = null;
                        eventDateInput.value = '';
                    }
                });
                calendarGridBody.appendChild(dayDiv);
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        });

        // Helper function to format military time to standard time (AM/PM)
        function formatTime(militaryTime) {
            if (!militaryTime) return '';
            const [hours, minutes] = militaryTime.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            return `${formattedHours}:${String(minutes).padStart(2, '0')} ${period}`;
        }
        
        // --- Deletion Confirmation Modal ---

        /**
         * Shows a confirmation modal for deleting an item.
         * @param {string} itemId - The ID of the item to be deleted.
         * @param {string} itemType - 'event' or 'task'
         */
        function showDeleteConfirmation(itemId, itemType) {
            modalText.textContent = `Are you sure you want to delete this ${itemType}?`;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
            modalConfirmBtn.onclick = () => {
                if (itemType === 'event') {
                    removeEvent(itemId);
                } else if (itemType === 'task') {
                    removeAssignment(itemId);
                }
                hideDeleteConfirmation();
            };
            modalCancelBtn.onclick = hideDeleteConfirmation;
        }

        /**
         * Hides the confirmation modal.
         */
        function hideDeleteConfirmation() {
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }

        // --- AI Summary Generation ---

        generateBtn.addEventListener('click', generateSummary);
        
        async function generateSummary() {
            loadingDiv.classList.remove('hidden');
            summaryOutputDiv.innerHTML = '';
            summaryOutputDiv.classList.add('hidden');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const sortedAssignments = sortAssignments(assignments.filter(a => !a.completed));
            const allTasksForLLM = sortedAssignments.map(a => {
                // BUG FIX: Correctly calculating the number of days until the deadline.
                // Using UTC dates and rounding ensures accuracy and avoids timezone issues.
                const oneDay = 1000 * 60 * 60 * 24;
                const todayUTC = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
                let daysDifference = -1;
                if (a.deadline) {
                    const deadline = new Date(a.deadline + 'T12:00:00');
                    const deadlineUTC = Date.UTC(deadline.getFullYear(), deadline.getMonth(), deadline.getDate());
                    daysDifference = Math.round((deadlineUTC - todayUTC) / oneDay);
                }

                const isUrgent = daysDifference <= VERY_SOON_DAYS || (a.difficulty === 'high' && daysDifference <= SEMI_SOON_DAYS);
                const parentTask = a.parentTaskId ? assignments.find(t => t.id === a.parentTaskId) : null;
                return {
                    title: a.title,
                    deadline: a.deadline,
                    daysUntil: daysDifference,
                    difficulty: a.difficulty.charAt(0).toUpperCase() + a.difficulty.slice(1),
                    taskType: a.taskType,
                    subject: a.subject || 'N/A',
                    isUrgent: isUrgent,
                    parentTaskTitle: parentTask ? parentTask.title : 'N/A',
                    id: a.id
                };
            });
            
            const upcomingEvents = events.filter(e => {
                const eventDate = new Date(e.date);
                const todayForDiff = new Date(today);
                return eventDate.setHours(0,0,0,0) >= todayForDiff.setHours(0,0,0,0);
            }).sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                if (a.time && b.time) return a.time.localeCompare(b.time);
                return 0;
            });
            
            const formattedEvents = upcomingEvents.map(e => ({
                title: e.title,
                location: e.location,
                date: e.date,
                time: e.time ? formatTime(e.time) : 'N/A',
            }));

            if (allTasksForLLM.length === 0 && formattedEvents.length === 0) {
                loadingDiv.classList.add('hidden');
                showMessage("Please add tasks or events before generating a summary.", "bg-red-500", 5000);
                return;
            }
            
            // Note: The AI call uses a structured prompt to get a JSON response.
            // The prompt asks the model to prioritize urgent tasks and upcoming events.
            const summaryPrompt = `
                Generate a daily summary and a detailed report based on the user's tasks and appointments.
                The output MUST be a JSON object with the following structure:
                {
                    "dailyFocus": ["A short, key-point sentence on the most urgent task.", "Another sentence on today's main work."],
                    "report": {
                        "appointments": [{"title": "Appointment title", "date": "YYYY-MM-DD", "time": "HH:MM", "location": "Location"}],
                        "tasks": [{"title": "Task title", "details": "Formatted details", "order": 1, "taskType": "general|school", "subject": "Subject name", "parentTask": "Parent task title"}]
                    }
                }
                The 'dailyFocus' should be 2-3 short, highly-prioritized sentences.
                The 'report' should contain all upcoming appointments and active tasks. List tasks in a numbered order of priority based on urgency (deadline and difficulty). For general tasks, use "Target completion: [date]". For school assignments, use "Due: [date]". All times must be in standard AM/PM format.
                
                Here is the raw data:
                
                All active tasks:
                ${allTasksForLLM.length > 0 ? JSON.stringify(allTasksForLLM) : 'No tasks.'}

                Upcoming Appointments:
                ${formattedEvents.length > 0 ? JSON.stringify(formattedEvents) : 'No upcoming calendar events.'}
            `;

            // --- LLM API Call with exponential backoff ---
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: summaryPrompt }] });
            const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json" } };
            const apiKey = GEMINI_API_KEY; // Using the provided Gemini API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            let attempts = 0;
            const maxAttempts = 5;
            
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) { throw new Error(`API error: ${response.status} ${response.statusText}`); }
                    
                    const result = await response.json();

                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const fullResponseData = JSON.parse(jsonText);
                        
                        renderDailySummary(fullResponseData.dailyFocus);
                        renderSummary(fullResponseData.report);
                        
                        summaryOutputDiv.classList.remove('hidden');
                    } else {
                        throw new Error('Unexpected API response structure.');
                    }
                    break;
                } catch(error) {
                    console.error('Error fetching from API:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        summaryOutputDiv.innerHTML = '<p class="text-red-500 text-center italic mt-4">Failed to generate a summary after multiple attempts. Please check your network connection.</p>';
                        summaryOutputDiv.classList.remove('hidden');
                    }
                } finally {
                    loadingDiv.classList.add('hidden');
                }
            }
        }

        // --- Summary Rendering ---
        
        /**
         * Renders the daily focus section from the AI response.
         * @param {Array<string>} summaryPoints - A list of key sentences.
         */
        function renderDailySummary(summaryPoints) {
            const oldSummary = document.getElementById('ai-summary-section');
            if (oldSummary) oldSummary.remove();
            
            const aiSummarySection = document.createElement('div');
            aiSummarySection.id = 'ai-summary-section';
            aiSummarySection.className = 'bg-[--main-bg-color] p-6 rounded-2xl shadow-md border border-[--border-color] mb-6';

            const summaryTitle = document.createElement('h3');
            summaryTitle.className = 'text-xl font-semibold text-[--text-color] mb-4';
            summaryTitle.textContent = `Daily Focus`;
            aiSummarySection.appendChild(summaryTitle);

            const summaryList = document.createElement('ul');
            summaryList.className = 'list-disc list-inside space-y-2';
            summaryPoints.forEach(point => {
                const li = document.createElement('li');
                li.className = 'text-[--text-color] leading-relaxed';
                li.textContent = point;
                summaryList.appendChild(li);
            });
            aiSummarySection.appendChild(summaryList);
            summaryOutputDiv.prepend(aiSummarySection);
        }
        
        /**
         * Renders the detailed report section from the AI response.
         * @param {Object} report - The report object containing appointments and tasks.
         */
        function renderSummary(report) {
            const existingReport = document.getElementById('ai-report-section');
            if (existingReport) existingReport.remove();
            
            summaryOutputDiv.classList.remove('hidden');
            summaryOutputDiv.className = 'bg-[--card-bg-color] p-6 rounded-2xl border border-[--border-color] shadow-md transition-opacity';
            
            const mainReportHeader = document.createElement('h2');
            mainReportHeader.className = 'text-2xl font-semibold text-[--text-color] mb-4';
            mainReportHeader.textContent = 'Daily Report';
            summaryOutputDiv.prepend(mainReportHeader);
            
            const reportSection = document.createElement('div');
            reportSection.id = 'ai-report-section';

            if (report.appointments && report.appointments.length > 0) {
                const appointmentsTitle = document.createElement('h4');
                appointmentsTitle.className = 'text-lg font-semibold text-[--text-color] mt-4 mb-4';
                appointmentsTitle.textContent = 'Upcoming Appointments';
                reportSection.appendChild(appointmentsTitle);

                const appointmentsList = document.createElement('div');
                appointmentsList.className = 'flex flex-col space-y-2';
                report.appointments.forEach(appointment => {
                    const card = document.createElement('div');
                    card.className = 'appointment-card bg-[--main-bg-color] rounded-xl shadow-sm border border-[--border-color]';
                    card.innerHTML = `
                        <div class="appointment-date-box">
                            <div class="month">${new Date(appointment.date).toLocaleDateString('en-US', { month: 'short' })}</div>
                            <div class="day">${new Date(appointment.date).toLocaleDateString('en-US', { day: '2-digit' })}</div>
                        </div>
                        <div class="flex-1 text-[--text-color]">
                            <p class="font-bold">${appointment.title}</p>
                            ${appointment.time ? `<p class="text-sm text-[--secondary-text-color]">Time: ${appointment.time}</p>` : ''}
                            ${appointment.location ? `<p class="text-sm text-[--secondary-text-color]">Location: ${appointment.location}</p>` : ''}
                        </div>
                    `;
                    appointmentsList.appendChild(card);
                });
                reportSection.appendChild(appointmentsList);
            }

            if (report.tasks && report.tasks.length > 0) {
                const tasksTitle = document.createElement('h4');
                tasksTitle.className = 'text-lg font-semibold text-[--text-color] mt-6 mb-4';
                tasksTitle.textContent = 'Today\'s Tasks';
                reportSection.appendChild(tasksTitle);

                const tasksList = document.createElement('div');
                tasksList.className = 'flex flex-col space-y-2';
                report.tasks.forEach(task => {
                    const card = document.createElement('div');
                    card.className = 'task-card bg-[--main-bg-color] rounded-xl shadow-sm border border-[--border-color]';
                    const subjectColor = task.subject && subjectColors[task.subject] ? subjectColors[task.subject] : '#4EA8DE';
                    let taskString = `
                        <span class="task-order">${task.order}.</span>
                        <div class="flex-1">
                            <p class="font-bold text-[--text-color]">${task.title}
                                ${task.subject && task.subject !== 'N/A' ? `<span class="subject-label" style="background-color: ${subjectColor};">${task.subject}</span>` : ''}
                                ${task.parentTask && task.parentTask !== 'N/A' ? `<span class="text-xs text-[--secondary-text-color] italic ml-2">(Subtask of: ${task.parentTask})</span>` : ''}
                            </p>
                            <p class="text-sm text-[--secondary-text-color] mt-1">${task.details}</p>
                        </div>
                    `;
                    card.innerHTML = taskString;
                    tasksList.appendChild(card);
                });
                reportSection.appendChild(tasksList);
            } else {
                const noTasksMessage = document.createElement('p');
                noTasksMessage.className = 'text-[--secondary-text-color] text-center italic mt-4';
                noTasksMessage.textContent = 'No tasks for today. You are all caught up!';
                reportSection.appendChild(noTasksMessage);
            }

            summaryOutputDiv.appendChild(reportSection);
        }
    </script>
</body>
</html>
